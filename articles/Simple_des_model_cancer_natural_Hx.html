<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>A simple discrete event simulation model of a cancer's natural history • nhppp</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="A simple discrete event simulation model of a cancer's natural history">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nhppp</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Log_linear_times.html">Sampling log-linear times</a></li>
    <li><a class="dropdown-item" href="../articles/Simple_des_model_cancer_natural_Hx.html">A simple discrete event simulation model of a cancer's natural history</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bladder-ca/nhppp/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>A simple discrete event simulation model of a cancer's natural history</h1>
                        <h4 data-toc-skip class="author">TA Trikalinos,
Y Sereda, S Chrysanthopoulou, F Alarid-Escudero</h4>
            
            <h4 data-toc-skip class="date">2024-10-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bladder-ca/nhppp/blob/main/vignettes/Simple_des_model_cancer_natural_Hx.Rmd" class="external-link"><code>vignettes/Simple_des_model_cancer_natural_Hx.Rmd</code></a></small>
      <div class="d-none name"><code>Simple_des_model_cancer_natural_Hx.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-simulation-world">The simulation world<a class="anchor" aria-label="anchor" href="#the-simulation-world"></a>
</h2>
<p>We will model a cancer’s natural history in a population. We index
people by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><mi>K</mi><mo stretchy="true" form="postfix">]</mo></mrow><mo>:=</mo><mo stretchy="false" form="prefix">{</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>K</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">k \in [K] := \{1, \dots, K \}</annotation></semantics></math>.
The following assumptions fix a simulation world.</p>
<ol style="list-style-type: decimal">
<li><p>All types of events can be modeleld with nonhomogeneous Poisson
point processes (NHPPPs).</p></li>
<li><p>Persons are alive and cancer free at 40 years of age. No person
will live past 110 years. All people can die from causes other than the
cancer of interest (hereafter, <em>death from other causes</em>). Write
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ρ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\rho_k(t)</annotation></semantics></math>
for the corresponding intensity function.</p></li>
<li><p>Some people may be exposed to an environmental toxin, with
exposure that varies over time. Write
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ξ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>≥</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\xi_k(t) \ge 0</annotation></semantics></math>
for the exposure function. Positive values mean that a person is exposed
at that particular instance. (The never exposed have zeros throughout
their life.) We will assume that the exposure to said toxin is a risk
factor only for cancer emergence, and that the toxin has no cumulative
effects – only the instantaneous exposure levels matter. Write
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mi>k</mi></msub><annotation encoding="application/x-tex">\delta_k</annotation></semantics></math>
for the effect of the toxin instantaneous exposure on developing
cancer.</p></li>
<li><p>Some persons will develop a preclinical cancer with a
time-varying intensity function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munder><munder><mrow><msub><mi>λ</mi><mrow><mi>k</mi><mn>0</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mo accent="true">⏟</mo></munder><mtext mathvariant="normal">non-risk factor part</mtext></munder><mo>+</mo><munder><munder><mrow><msub><mi>δ</mi><mi>k</mi></msub><mspace width="0.222em"></mspace><msub><mi>ξ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mo accent="true">⏟</mo></munder><mtext mathvariant="normal">risk factor part</mtext></munder></mrow><annotation encoding="application/x-tex">\lambda_{k}(t) = \underbrace{\lambda_{k0}(t)}_{\textrm{non-risk factor part}} + \underbrace{\delta_k \ \xi_k(t)}_{\textrm{risk factor part}}</annotation></semantics></math>.</p></li>
<li><p>Some preclinical cancers may progress to clinical cancer with an
intensity function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mu_k(t)</annotation></semantics></math>,
at which point they are considered diagnosed.</p></li>
<li><p>Once people develop preclinical cancer they can die from cancer
with intensity function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ν</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\nu_k(t)</annotation></semantics></math>.
The cancer death rate does not explicitly depend on whether the cancer
has been diagnosed or not. Thus, we have two competing causes of death:
death due to cancer and due to other causes.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>Load <code>nhppp</code> and <code>data.table</code>. (If you prefer
to not use <code>data.table</code>, you should be able to implement this
example in base <code>R</code> with little trouble.)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bladder-ca.github.io/nhppp/">nhppp</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulation-model">Simulation model<a class="anchor" aria-label="anchor" href="#simulation-model"></a>
</h2>
<p>We now fix the mathematical description of the model. We will
simulate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">K = 10^{5}</annotation></semantics></math>
males and females (with equal probability) from the 2015 birth
cohort.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">K</span>,</span>
<span>  birth_cohort <span class="op">=</span> <span class="fl">2015</span>,</span>
<span>  spawn_age <span class="op">=</span> <span class="fl">40</span>,</span>
<span>  max_simulation_age <span class="op">=</span> <span class="fl">110</span>,</span>
<span>  sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span>, <span class="va">K</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## It would make sense to execute the commented-out code now.</span></span>
<span><span class="co">## It generates model parameters used in later stages.</span></span>
<span><span class="co">## For expository clarity, we generate each parameter when it is introduced</span></span>
<span><span class="co"># pop[, `:=`(</span></span>
<span><span class="co">#    param_cancer_emergence_shape = runif(.N, 7, 9),</span></span>
<span><span class="co">#    param_cancer_emergence_scale = rnorm(.N, 150, 20),</span></span>
<span><span class="co">#    param_toxin_exposure_diff = pmax(0.005, rnorm(.N, 0.01, 0.005)),</span></span>
<span><span class="co">#    param_cancer_death_intercept := rnorm(.N, -2, 0.5),</span></span>
<span><span class="co">#    param_cancer_death_slope := runif(n= .N, min = 0, max = 0.003),</span></span>
<span><span class="co">#    param_clinical_cancer_dx_rate := runif(.N, 0.20, 0.27)</span></span>
<span><span class="co">#  )]</span></span></code></pre></div>
<div class="section level3">
<h3 id="death-from-other-causes">Death from other causes<a class="anchor" aria-label="anchor" href="#death-from-other-causes"></a>
</h3>
<p>The death from other causes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ρ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\rho_k(t)</annotation></semantics></math>
depends on the age
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
measured in years), sex (male or female), and birth year of person
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>.
Function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ρ</mi><annotation encoding="application/x-tex">\rho</annotation></semantics></math>
is is a piecewise constant over each year of age. It is a `regular’ step
function (all steps have the same length of one year).</p>
<p>If the cancer is not a major cause of death, then the intensity
function for all cause deaths is a good approximation for the intensity
function for death from other causes. The internal dataset
<code>annual_mortality_rates_2015</code> has all cause mortality data
for the 2015 birth cohort. It has the values of the piecewise constant
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ρ</mi><annotation encoding="application/x-tex">\rho</annotation></semantics></math>
per birth cohort, sex, and age. Here is a peek at some columns.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">annual_mortality_rates_2015</span><span class="op">[</span></span>
<span>  <span class="va">sex</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">111</span><span class="op">:</span><span class="fl">113</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span><span class="co">#&gt; Key: &lt;birth_cohort, sex&gt;</span></span>
<span><span class="co">#&gt;    birth_cohort    sex    age_0    age_1    age_2  age_108  age_109 age_110+</span></span>
<span><span class="co">#&gt;           &lt;int&gt; &lt;fctr&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:         2015 female 0.005386 0.000350 0.000228 0.559371 0.541174 0.587413</span></span>
<span><span class="co">#&gt; 2:         2015   male 0.006404 0.000452 0.000277 0.511677 0.671391 0.386100</span></span></code></pre></div>
<p>When we have a <em>step</em> (piecewise constant) intensity function
over <em>regular</em> time intervals (here, all one year long), we can
use <code>nhppp</code>’s <code><a href="../reference/vdraw_sc_step_regular.html">vdraw_sc_step_regular()</a></code> function.
We need to specify the following:</p>
<ol style="list-style-type: decimal">
<li>Pass the intensities as a matrix (argument
<code>lambda_matrix</code>); the number of columns in the matrix are the
number of time intervals in the step function.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rhos</span> <span class="op">&lt;-</span> <span class="va">annual_mortality_rates_2015</span><span class="op">[</span></span>
<span>  <span class="va">pop</span>,</span>
<span>  on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"birth_cohort"</span>, <span class="st">"sex"</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setindex</a></span><span class="op">(</span><span class="va">rhos</span>, <span class="st">"id"</span><span class="op">)</span></span>
<span><span class="va">rho_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">rhos</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"age_"</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">109</span><span class="op">)</span>, <span class="st">"age_110+"</span><span class="op">)</span>,</span>
<span>  with <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="st">"rhos"</span><span class="op">)</span> <span class="co"># cleanup</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li><p>Give information about how long each time step is, by specifying
the age bounds <code>rate_matrix_t_min</code> and
<code>rate_matrix_t_max</code> over which the intensity matrix
applies;</p></li>
<li><p>Optionally, if we want to sample times in a sub-interval of
<code>(rate_matrix_t_min, rate_matrix_t_max]</code>, we can specify even
narrower bounds, <code>t_min</code> and <code>t_max</code>. If you omit
<code>t_min</code> or <code>t_max</code>, the software uses
<code>rate_matrix_t_min</code> or <code>rate_matrix_t_max</code>,
respectively, to specify the sampling interval.</p></li>
<li><p>Because no person lives beyond the maximum simulation age of 110
years, we need to force the simulation of at least one death event over
the simulation interval. This means that we are sampling from a
zero-truncated NHPPP. Setting the option <code>atleast1</code> to
<code>TRUE</code> achieves this.</p></li>
<li><p>We only need to sample the earliest event from this NHPPP. So we
set the <code>atmost1</code> option to <code>TRUE</code>.</p></li>
</ol>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span><span class="op">[</span></span>
<span>  ,</span>
<span>  <span class="va">age_dead_from_other_causes</span> <span class="op">:=</span></span>
<span>    <span class="fu">nhppp</span><span class="fu">::</span><span class="fu"><a href="../reference/vdraw_sc_step_regular.html">vdraw_sc_step_regular</a></span><span class="op">(</span></span>
<span>      lambda_matrix <span class="op">=</span> <span class="va">rho_matrix</span>,</span>
<span>      rate_matrix_t_min <span class="op">=</span> <span class="fl">0</span>,</span>
<span>      rate_matrix_t_max <span class="op">=</span> <span class="fl">110</span>,</span>
<span>      t_min <span class="op">=</span> <span class="va">pop</span><span class="op">$</span><span class="va">spawn_age</span>, <span class="co"># 40</span></span>
<span>      t_max <span class="op">=</span> <span class="va">pop</span><span class="op">$</span><span class="va">max_simulation_age</span>, <span class="co"># 110</span></span>
<span>      atmost1 <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      atleast1 <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="environmental-toxin-exposure-histories">Environmental toxin exposure histories<a class="anchor" aria-label="anchor" href="#environmental-toxin-exposure-histories"></a>
</h3>
<p>We will generate environmental exposure histories with a
phenomenological model. We will assume that</p>
<ol style="list-style-type: decimal">
<li><p>People may be exposed to the environmental toxin with probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>=</mo><mn>0.20</mn></mrow><annotation encoding="application/x-tex">p_{start} = 0.20</annotation></semantics></math>.</p></li>
<li><p>For those who will be exposed, the start age of exposure is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>k</mi><mn>0</mn></mrow></msub><mo>∼</mo><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>12</mn><mo>,</mo><mn>35</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">t_{k0} \sim U(12, 35)</annotation></semantics></math>,
provided that they are still alive.</p></li>
<li><p>Among those who are exposed, the probability that their exposure
will eventually stop is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>s</mi><mi>t</mi><mi>o</mi><mi>p</mi></mrow></msub><mo>=</mo><mn>0.60</mn></mrow><annotation encoding="application/x-tex">p_{stop} = 0.60</annotation></semantics></math>.</p></li>
<li><p>In the pertinent subgroup of persons, the duration of the
exposure is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>∼</mo><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>,</mo><mn>35</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">d_k \sim U(1, 35)</annotation></semantics></math>,
if they are still alive.</p></li>
<li><p>For people with at least some exposure to the toxin, for all
times in the exposure window
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>k</mi><mn>0</mn></mrow></msub><mo>,</mo><msub><mi>t</mi><mrow><mi>k</mi><mn>1</mn></mrow></msub><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">(t_{k0}, t_{k1}]</annotation></semantics></math>
the exposure levels are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ξ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>Ξ</mi><mi>k</mi></msub><mo>⋅</mo><mo minsize="1.8" maxsize="1.8" stretchy="false" form="prefix">(</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>+</mo><mfrac><mn>1</mn><mn>4</mn></mfrac><mo minsize="1.2" maxsize="1.2" stretchy="false" form="prefix">(</mo><mo>cos</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0.5</mn><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>cos</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0.45</mn><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo minsize="1.2" maxsize="1.2" stretchy="false" form="postfix">)</mo><mo minsize="1.8" maxsize="1.8" stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\xi_k(t) = \Xi_k \cdot \Big(\frac{1}{2} +\frac{1}{4}\big(\cos(0.5 t) + \cos(0.45 t) \big) \Big)</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
is a person’s age and the amplitude (maximum exposure)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Ξ</mi><mi>k</mi></msub><annotation encoding="application/x-tex">\Xi_k</annotation></semantics></math>
has model
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Ξ</mi><mi>k</mi></msub><mo>∼</mo><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0.2</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\Xi_k \sim U(0.2, 1)</annotation></semantics></math>.
Otherwise,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ξ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\xi_k(t) = 0</annotation></semantics></math>.</p></li>
</ol>
<p>We now add the per-person parameters for exposure histories in the
population data.table. For people who will never be exposed we set
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Ξ</mi><mi>k</mi></msub><annotation encoding="application/x-tex">\Xi_k</annotation></semantics></math>
to zero, and their exposure start and stop ages at the
<code>max_simuation_age</code>. This avoids <code>if ... else</code>
statements, and is still pretty fast. If you run a massive model,
though, you may want to be smarter about it.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  exposure_start_age <span class="op">=</span> <span class="va">max_simulation_age</span>,</span>
<span>  exposure_stop_age <span class="op">=</span> <span class="va">max_simulation_age</span>,</span>
<span>  maximum_exposure <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span></span>
<span>  ,</span>
<span>  <span class="va">will_start_exposure</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.20</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="va">will_start_exposure</span> <span class="op">==</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">will_stop_exposure</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.60</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="va">will_start_exposure</span> <span class="op">==</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">exposure_start_age</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">12</span>, <span class="fl">35</span><span class="op">)</span>, <span class="va">age_dead_from_other_causes</span><span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="va">will_stop_exposure</span> <span class="op">==</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">exposure_stop_age</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span></span>
<span>    <span class="va">exposure_start_age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">1</span>, <span class="fl">35</span><span class="op">)</span>,</span>
<span>    <span class="va">age_dead_from_other_causes</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="va">will_start_exposure</span> <span class="op">==</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">maximum_exposure</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># cleanup</span></span>
<span><span class="va">pop</span><span class="op">[</span>, <span class="va">will_start_exposure</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span><span class="op">[</span>, <span class="va">will_stop_exposure</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span></code></pre></div>
<p>We implement
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ξ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\xi_k(t)</annotation></semantics></math>
as a function that is vectorized over all its arguments. The arguments
<code>start_age</code>, <code>stop_age</code>, <code>max_exposure</code>
correspond to the variables
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>k</mi><mn>0</mn></mrow></msub><mo>,</mo><msub><mi>t</mi><mrow><mi>k</mi><mn>1</mn></mrow></msub><mo>,</mo><mi>Ξ</mi></mrow><annotation encoding="application/x-tex">t_{k0}, t_{k1}, \Xi</annotation></semantics></math>
in the equation above.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xi</span> <span class="op">&lt;-</span> <span class="va">toxin_exposure</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">max_exposure</span>, <span class="va">start_age</span>, <span class="va">stop_age</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">(</span><span class="va">start_age</span> <span class="op">&lt;=</span> <span class="va">t</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">stop_age</span> <span class="op">&gt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">max_exposure</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">t</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="fl">0.9</span> <span class="op">*</span> <span class="va">t</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="emergence-of-pre-clinical-cancer-in-unexposed-and-exposed-intervals">Emergence of pre-clinical cancer in unexposed and exposed
intervals<a class="anchor" aria-label="anchor" href="#emergence-of-pre-clinical-cancer-in-unexposed-and-exposed-intervals"></a>
</h3>
<p>Assume that the intensity function for cancer emergence in the
absence of toxin exposure is</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mrow><mi>k</mi><mn>0</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mi>s</mi><mi>h</mi><mi>a</mi><mi>p</mi><msub><mi>e</mi><mi>k</mi></msub></mrow><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><msub><mi>e</mi><mi>k</mi></msub></mrow></mfrac><mo minsize="1.8" maxsize="1.8" stretchy="false" form="prefix">(</mo><mfrac><mi>t</mi><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><msub><mi>e</mi><mi>k</mi></msub></mrow></mfrac><msup><mo minsize="1.8" maxsize="1.8" stretchy="false" form="postfix">)</mo><mrow><mi>s</mi><mi>h</mi><mi>a</mi><mi>p</mi><msub><mi>e</mi><mi>k</mi></msub><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\lambda_{k0}(t) = \frac{shape_k}{scale_k} \Big(\frac{t}{scale_k}\Big)^{shape_k -1}</annotation></semantics></math>,</p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
is age in years.</p>
<p>This intensity function generates a Weibull point process (a special
case of an NHPPP). The parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>h</mi><mi>a</mi><mi>p</mi><msub><mi>e</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">shape_k</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><msub><mi>e</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">scale_k</annotation></semantics></math>
are assumed to vary across people according to the models
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>h</mi><mi>a</mi><mi>p</mi><msub><mi>e</mi><mi>k</mi></msub><mo>∼</mo><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>7</mn><mo>,</mo><mn>9</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">shape_k \sim U(7, 9)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><msub><mi>e</mi><mi>k</mi></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>150</mn><mo>,</mo><mn>20</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">scale_k \sim N(150, 20)</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">U(\cdot)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N(\cdot)</annotation></semantics></math>
stand for uniform and normal distributions. We sample these values for
each person in the population.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  param_cancer_emergence_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">7</span>, <span class="fl">9</span><span class="op">)</span>,</span>
<span>  param_cancer_emergence_scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">150</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Generating a Weibull point process is easy in <code>R</code> using
the <code><a href="https://rdrr.io/r/stats/Weibull.html" class="external-link">stats::rweibull()</a></code> function. (This would take care of
the cancer emergence times for people without toxin exposure, but not
for people with toxin exposures.) Accounting for toxin exposure
histories, the intensity function for cancer emergence is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>l</mi><mrow><mi>k</mi><mn>0</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>δ</mi><mi>k</mi></msub><msub><mi>ξ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_{k}(t) = l_{k0}(t) + \delta_k \xi_k(t)</annotation></semantics></math>.</p>
<p>We will assume that the toxin exposure effect
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mi>k</mi></msub><annotation encoding="application/x-tex">\delta_k</annotation></semantics></math>
is distributed as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>δ</mi><mi>k</mi></msub><mo>∼</mo><msub><mi>N</mi><mo>+</mo></msub><mo minsize="1.2" maxsize="1.2" stretchy="false" form="prefix">(</mo><mn>2</mn><mo>,</mo><mn>0.5</mn><mo minsize="1.2" maxsize="1.2" stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\delta_k \sim N_+\big(2, 0.5\big)</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mo>+</mo></msub><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N_+(\cdot)</annotation></semantics></math>
is a slab and smear normal distribution.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span><span class="op">[</span>, <span class="va">param_toxin_exposure_diff</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">0.01</span>, <span class="fl">0.005</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>We need to sample from an NHPPP with an intensity function that
varies over time as per
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_k(t)</annotation></semantics></math>.
We will use <code>nhppp</code>’s <code><a href="../reference/vdraw_intensity.html">vdraw_intensity()</a></code>
function, which needs</p>
<ol style="list-style-type: decimal">
<li><p>The intensity function (argument <code>lambda</code>) in a
vectorized form, so that age
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
is the only needed argument and all other arguments are set by
default.</p></li>
<li><p>A majorizer piecewise constant function, which will be specified
as a matrix <code>lambda_maj_matrix</code>.</p></li>
<li><p>The <code>rate_matrix_t_min</code>,
<code>rate_matrix_t_max</code> arguments that specify the time bounds
for the matrix <code>lambda_maj_matrix</code>.</p></li>
<li><p><code>t_min</code>, and <code>t_max</code> arguments, for the
subinterval over whchi we will sample times. Here,
<code>t_min = 40</code> – the spawn age in the simulation, and
<code>t_max</code> is the
<code>age_dead_from_other_causes</code>.</p></li>
</ol>
<p>Let’s implement the above.</p>
<p>The <em>intensity function</em> is specified as follows. Observe that
it is in vectorized form.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">P</span> <span class="op">=</span> <span class="va">pop</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># non-risk factor part: shape / scale * (t/scale)^(shape - 1)</span></span>
<span>  <span class="op">(</span><span class="va">P</span><span class="op">$</span><span class="va">param_cancer_emergence_shape</span> <span class="op">/</span> <span class="va">P</span><span class="op">$</span><span class="va">param_cancer_emergence_scale</span><span class="op">)</span> <span class="op">*</span></span>
<span>    <span class="op">(</span><span class="va">t</span> <span class="op">/</span> <span class="va">P</span><span class="op">$</span><span class="va">param_cancer_emergence_scale</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="va">P</span><span class="op">$</span><span class="va">param_cancer_emergence_shape</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># risk factor (toxin exposure) part: delta_k * xi(t)</span></span>
<span>    <span class="va">P</span><span class="op">$</span><span class="va">param_toxin_exposure_diff</span> <span class="op">*</span></span>
<span>      <span class="fu">xi</span><span class="op">(</span></span>
<span>        t <span class="op">=</span> <span class="va">t</span>,</span>
<span>        max_exposure <span class="op">=</span> <span class="va">P</span><span class="op">$</span><span class="va">maximum_exposure</span>,</span>
<span>        start_age <span class="op">=</span> <span class="va">P</span><span class="op">$</span><span class="va">exposure_start_age</span>,</span>
<span>        stop_age <span class="op">=</span> <span class="va">P</span><span class="op">$</span><span class="va">exposure_stop_age</span></span>
<span>      <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We also need a piecewise constant <em>majorizer</em> function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mo>*</mo></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_*(t)</annotation></semantics></math>.
We say that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mo>*</mo></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_*(t)</annotation></semantics></math>
majorizes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda(t)</annotation></semantics></math>
if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mo>*</mo></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>≥</mo><mi>λ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_*(t) \ge \lambda(t)</annotation></semantics></math>
for all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
of interest. The function expects a <em>regular step</em> majorizer
function. We will create such a function with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">M = 10</annotation></semantics></math>
equally-spaced intervals over the whole simulation window. First,
generate the endpoints of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>
intervals. This will be a matrix where the rows correspond to persons
and the columns to the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>+</mo><mn>1</mn><mo>=</mo><mn>11</mn></mrow><annotation encoding="application/x-tex">M + 1 =11</annotation></semantics></math>
interval bounds.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define interval bounds for the step function, one row per person</span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">time_breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">40</span>, to <span class="op">=</span> <span class="fl">110</span>, length.out <span class="op">=</span> <span class="va">M</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,</span>
<span>  byrow <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  nrow <span class="op">=</span> <span class="va">K</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">time_breaks</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11]</span></span>
<span><span class="co">#&gt; [1,]   40   47   54   61   68   75   82   89   96   103   110</span></span>
<span><span class="co">#&gt; [2,]   40   47   54   61   68   75   82   89   96   103   110</span></span>
<span><span class="co">#&gt; [3,]   40   47   54   61   68   75   82   89   96   103   110</span></span></code></pre></div>
<p>… and now generate the majorizer matrix using <code>nhppp</code>’s
<code><a href="../reference/get_step_majorizer.html">get_step_majorizer()</a></code> function. (The paper in the
Bibliography explains how this function works.)</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambda_star</span> <span class="op">&lt;-</span> <span class="fu">nhppp</span><span class="fu">::</span><span class="fu"><a href="../reference/get_step_majorizer.html">get_step_majorizer</a></span><span class="op">(</span></span>
<span>  fun <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>  breaks <span class="op">=</span> <span class="va">time_breaks</span>,</span>
<span>  is_monotone <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  K <span class="op">=</span> <span class="fl">1.9</span> <span class="op">/</span> <span class="fl">4</span> <span class="co"># This is the maximum slope of xi() -- which you get with some calculus</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lambda_star</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;          [,1]     [,2]     [,3]     [,4]     [,5]     [,6]     [,7]     [,8]</span></span>
<span><span class="co">#&gt; [1,] 1.664784 1.664424 1.664424 1.664554 1.665456 1.665944 1.667683 1.669700</span></span>
<span><span class="co">#&gt; [2,] 1.662535 1.662590 1.662706 1.662929 1.663331 1.664018 1.665139 1.666900</span></span>
<span><span class="co">#&gt; [3,] 1.662512 1.662533 1.662580 1.662677 1.662861 1.663191 1.663756 1.664682</span></span>
<span><span class="co">#&gt;          [,9]    [,10]</span></span>
<span><span class="co">#&gt; [1,] 1.672383 1.677464</span></span>
<span><span class="co">#&gt; [2,] 1.669577 1.673531</span></span>
<span><span class="co">#&gt; [3,] 1.666145 1.668387</span></span></code></pre></div>
<p>And now, we can sample the cancer generation times, and create a
variable to identify patients with cancer.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span><span class="op">[</span></span>
<span>  ,</span>
<span>  <span class="va">age_cancer_emergence</span> <span class="op">:=</span> <span class="fu">nhppp</span><span class="fu">::</span><span class="fu"><a href="../reference/vdraw_intensity.html">vdraw_intensity</a></span><span class="op">(</span></span>
<span>    lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>    lambda_maj_matrix <span class="op">=</span> <span class="va">lambda_star</span>,</span>
<span>    rate_matrix_t_min <span class="op">=</span> <span class="fl">40</span>,</span>
<span>    rate_matrix_t_max <span class="op">=</span> <span class="fl">110</span>,</span>
<span>    t_min <span class="op">=</span> <span class="va">pop</span><span class="op">$</span><span class="va">spawn_age</span>,</span>
<span>    t_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">pop</span><span class="op">$</span><span class="va">age_dead_from_other_causes</span>, <span class="fl">110</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    atmost1 <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  ,</span>
<span>  <span class="va">with_cancer</span> <span class="op">:=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>,</span>
<span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="dying-from-cancer">Dying from cancer<a class="anchor" aria-label="anchor" href="#dying-from-cancer"></a>
</h3>
<p>People with preclinical cancer may die from cancer causes. We will
assume that the intensity from cancer deaths is loglinear in time, that
is</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ν</mi><mi>k</mi></msub><mo>=</mo><msup><mi>e</mi><mrow><msub><mi>α</mi><mi>k</mi></msub><mo>+</mo><msub><mi>β</mi><mi>k</mi></msub><mi>t</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\nu_k = e^{\alpha_k + \beta_k t}</annotation></semantics></math>,</p>
<p>with parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>k</mi></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>−</mo><mn>3</mn><mo>,</mo><mn>0.2</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha_k \sim N(-3, 0.2)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mi>k</mi></msub><mspace width="0.222em"></mspace><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>0.003</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\beta_k ~ U(0, 0.003)</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span><span class="op">[</span>, <span class="va">param_cancer_death_intercept</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">.N</span>, <span class="op">-</span><span class="fl">3</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">pop</span><span class="op">[</span>, <span class="va">param_cancer_death_slope</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">0</span>, <span class="fl">0.003</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>We could use the <code><a href="../reference/vdraw_intensity.html">vdraw_intensity()</a></code> function again, since
we already know the intensity
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ν</mi><mi>k</mi></msub><annotation encoding="application/x-tex">\nu_k</annotation></semantics></math>
and we can easily create a majorizer function for it, as we did when we
generated cancer emergence times. This would be plenty fast for our
small simulation with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">K = 10^{5}</annotation></semantics></math>
and requires no additional mathematics.</p>
<p>We can sample even faster if we can analytically obtain the
cumulative intensity function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mrow><msub><mi>ν</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.222em"></mspace><mtext mathvariant="normal">d</mtext><mi>s</mi></mrow></mrow><annotation encoding="application/x-tex">N_k(t) = \int_0^t{\nu_k(s) \ \textrm{d}s}</annotation></semantics></math>,
and its inverse
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>N</mi><mi>k</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N_k^{-1}(z)</annotation></semantics></math>.
(The inverse function recovers
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
from the value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N_k(t)</annotation></semantics></math>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><msubsup><mi>N</mi><mi>k</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><mo minsize="1.2" maxsize="1.2" stretchy="false" form="prefix">(</mo><msub><mi>N</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo minsize="1.2" maxsize="1.2" stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">t = N_k^{-1}\big( N_k(t)\big)</annotation></semantics></math>).
This sampling is done with <code>nhppp</code>’s
<code><a href="../reference/vdraw_cumulative_intensity.html">vdraw_cumulative_intensity()</a></code> function.</p>
<p>A bit of calculus can yield
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><msub><mi>β</mi><mi>k</mi></msub></mfrac><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>e</mi><mrow><msub><mi>α</mi><mi>k</mi></msub><mo>+</mo><msub><mi>β</mi><mi>k</mi></msub><mi>t</mi></mrow></msup><mo>−</mo><msup><mi>e</mi><msub><mi>α</mi><mi>k</mi></msub></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N_k(t) = \frac{1}{\beta_k} (e^{\alpha_k + \beta_k t} - e^{\alpha_k})</annotation></semantics></math>,
which we can implement in vectorized form and with default parameters
already set:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Nu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">Lambda_args</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">P</span> <span class="op">&lt;-</span> <span class="va">Lambda_args</span><span class="op">$</span><span class="va">population</span></span>
<span>  <span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">P</span><span class="op">$</span><span class="va">param_cancer_death_intercept</span> <span class="op">+</span> <span class="va">P</span><span class="op">$</span><span class="va">param_cancer_death_slope</span> <span class="op">*</span> <span class="va">t</span><span class="op">)</span> <span class="op">-</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">P</span><span class="op">$</span><span class="va">param_cancer_death_intercept</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">/</span> <span class="va">P</span><span class="op">$</span><span class="va">param_cancer_death_slope</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The inverse
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>N</mi><mi>k</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N_k^{-1}(\cdot)</annotation></semantics></math>
is</p>
<p>$N_k^{-1}(z) = ( ( _k z + e^_k ) - _k )/_k $</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Nu_inv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span>, <span class="va">Lambda_inv_args</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">P</span> <span class="op">&lt;-</span> <span class="va">Lambda_inv_args</span><span class="op">$</span><span class="va">population</span></span>
<span>  <span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">P</span><span class="op">$</span><span class="va">param_cancer_death_slope</span> <span class="op">*</span> <span class="va">z</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">P</span><span class="op">$</span><span class="va">param_cancer_death_intercept</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span></span>
<span>      <span class="va">P</span><span class="op">$</span><span class="va">param_cancer_death_intercept</span></span>
<span>  <span class="op">)</span> <span class="op">/</span> <span class="va">P</span><span class="op">$</span><span class="va">param_cancer_death_slope</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then, we can sample the times to cancer death.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">args_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">pop</span><span class="op">[</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>,</span>
<span>  <span class="va">age_dead_from_cancer_causes</span> <span class="op">:=</span> <span class="fu">nhppp</span><span class="fu">::</span><span class="fu"><a href="../reference/vdraw_cumulative_intensity.html">vdraw_cumulative_intensity</a></span><span class="op">(</span></span>
<span>    Lambda <span class="op">=</span> <span class="va">Nu</span>,</span>
<span>    Lambda_args <span class="op">=</span> <span class="va">args_list</span>,</span>
<span>    Lambda_inv <span class="op">=</span> <span class="va">Nu_inv</span>,</span>
<span>    Lambda_inv_args <span class="op">=</span> <span class="va">args_list</span>,</span>
<span>    t_min <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>, <span class="va">age_cancer_emergence</span><span class="op">]</span>,</span>
<span>    t_max <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>, <span class="va">age_dead_from_other_causes</span><span class="op">]</span>,</span>
<span>    atmost1 <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="st">"args_list"</span><span class="op">)</span> <span class="co"># cleanup</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="dying-from-all-causes">Dying from all causes<a class="anchor" aria-label="anchor" href="#dying-from-all-causes"></a>
</h3>
<p>The age of death from all causes is the minimum of the ages across
both causes of death.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span><span class="op">[</span></span>
<span>  ,</span>
<span>  <span class="va">age_dead</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">age_dead_from_other_causes</span>,</span>
<span>    <span class="va">age_dead_from_cancer_causes</span>,</span>
<span>    na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="clinical-cancer-diagnosis">Clinical cancer diagnosis<a class="anchor" aria-label="anchor" href="#clinical-cancer-diagnosis"></a>
</h3>
<p>Cancers first emerge in a pre-clinical stage. Some will be diagnosed
as<br>
clinical cancers with intensity function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>μ</mi><mi>k</mi></msub><annotation encoding="application/x-tex">\mu_k</annotation></semantics></math>.
We will assume that clinical diagnosis has constant rate which is
distributed according to the model</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>:=</mo><msub><mi>μ</mi><mi>k</mi></msub><mo>∼</mo><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0.20</mn><mo>,</mo><mn>0.27</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mu_k(t) := \mu_k \sim U(0.20, 0.27)</annotation></semantics></math>,</p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
indexes over people with cancer.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span><span class="op">[</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>,</span>
<span>  <span class="va">param_clinical_cancer_dx_rate</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">0.20</span>, <span class="fl">0.27</span><span class="op">)</span></span>
<span><span class="op">]</span></span></code></pre></div>
<p>Constant rates result in exponential times, which we can easily
sample with the <code><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">stats::rexp()</a></code> function, as per the
commented out code below.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Using rexp()</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pop</span><span class="op">[</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>,</span>
<span>  <span class="va">age_clinical_cancer_dx</span> <span class="op">:=</span></span>
<span>    <span class="va">age_cancer_emergence</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">.N</span>, rate <span class="op">=</span> <span class="va">param_clinical_cancer_dx_rate</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span><span class="va">pop</span><span class="op">[</span></span>
<span>  <span class="va">age_clinical_cancer_dx</span> <span class="op">&gt;=</span> <span class="va">age_dead</span>,</span>
<span>  <span class="va">age_clinical_cancer_dx</span> <span class="op">:=</span> <span class="cn">NA</span></span>
<span><span class="op">]</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0.004 sec elapsed</span></span></code></pre></div>
<p>With <code>nhppp</code>, we can use the
<code><a href="../reference/vdraw_sc_step_regular.html">vdraw_sc_step_regular()</a></code> function that samples from
piecewise constant intensities. (A constant function over an interval is
still a piecewise constant function – with a single piece.) The
<code>nhppp</code> implementation will be only a bit slower – but it is
worth showing.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mu_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">pop</span><span class="op">[</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>,</span>
<span>  <span class="va">param_clinical_cancer_dx_rate</span></span>
<span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pop</span><span class="op">[</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>,</span>
<span>  <span class="va">age_clinical_cancer_dx</span> <span class="op">:=</span> <span class="fu">nhppp</span><span class="fu">::</span><span class="fu"><a href="../reference/vdraw_sc_step_regular.html">vdraw_sc_step_regular</a></span><span class="op">(</span></span>
<span>    lambda_matrix <span class="op">=</span> <span class="va">mu_mat</span>,</span>
<span>    rate_matrix_t_min <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>, <span class="va">age_cancer_emergence</span><span class="op">]</span>,</span>
<span>    rate_matrix_t_max <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">age_cancer_emergence</span><span class="op">)</span>, <span class="va">age_dead</span><span class="op">]</span>,</span>
<span>    atmost1 <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0.004 sec elapsed</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="some-descriptives">Some descriptives<a class="anchor" aria-label="anchor" href="#some-descriptives"></a>
</h2>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># pop$age_cancer_emergence |&gt; summary()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span></span>
<span><span class="co">#&gt;        id          birth_cohort    spawn_age  max_simulation_age</span></span>
<span><span class="co">#&gt;  Min.   :     1   Min.   :2015   Min.   :40   Min.   :110       </span></span>
<span><span class="co">#&gt;  1st Qu.: 25001   1st Qu.:2015   1st Qu.:40   1st Qu.:110       </span></span>
<span><span class="co">#&gt;  Median : 50000   Median :2015   Median :40   Median :110       </span></span>
<span><span class="co">#&gt;  Mean   : 50000   Mean   :2015   Mean   :40   Mean   :110       </span></span>
<span><span class="co">#&gt;  3rd Qu.: 75000   3rd Qu.:2015   3rd Qu.:40   3rd Qu.:110       </span></span>
<span><span class="co">#&gt;  Max.   :100000   Max.   :2015   Max.   :40   Max.   :110       </span></span>
<span><span class="co">#&gt;                                                                 </span></span>
<span><span class="co">#&gt;      sex            age_dead_from_other_causes exposure_start_age</span></span>
<span><span class="co">#&gt;  Length:100000      Min.   : 40.01             Min.   : 12.00    </span></span>
<span><span class="co">#&gt;  Class :character   1st Qu.: 72.82             1st Qu.:110.00    </span></span>
<span><span class="co">#&gt;  Mode  :character   Median : 82.57             Median :110.00    </span></span>
<span><span class="co">#&gt;                     Mean   : 80.20             Mean   : 92.69    </span></span>
<span><span class="co">#&gt;                     3rd Qu.: 89.58             3rd Qu.:110.00    </span></span>
<span><span class="co">#&gt;                     Max.   :109.87             Max.   :110.00    </span></span>
<span><span class="co">#&gt;                                                                  </span></span>
<span><span class="co">#&gt;  exposure_stop_age maximum_exposure param_cancer_emergence_shape</span></span>
<span><span class="co">#&gt;  Min.   : 13.32    Min.   :0.00     Min.   :7.000               </span></span>
<span><span class="co">#&gt;  1st Qu.:110.00    1st Qu.:0.00     1st Qu.:7.501               </span></span>
<span><span class="co">#&gt;  Median :110.00    Median :0.00     Median :8.002               </span></span>
<span><span class="co">#&gt;  Mean   :101.76    Mean   :0.12     Mean   :8.001               </span></span>
<span><span class="co">#&gt;  3rd Qu.:110.00    3rd Qu.:0.00     3rd Qu.:8.502               </span></span>
<span><span class="co">#&gt;  Max.   :110.00    Max.   :1.00     Max.   :9.000               </span></span>
<span><span class="co">#&gt;                                                                 </span></span>
<span><span class="co">#&gt;  param_cancer_emergence_scale param_toxin_exposure_diff age_cancer_emergence</span></span>
<span><span class="co">#&gt;  Min.   : 67.46               Min.   :0.000000          Min.   : 40.01      </span></span>
<span><span class="co">#&gt;  1st Qu.:136.42               1st Qu.:0.006624          1st Qu.: 57.42      </span></span>
<span><span class="co">#&gt;  Median :149.99               Median :0.010004          Median : 72.15      </span></span>
<span><span class="co">#&gt;  Mean   :149.94               Mean   :0.010052          Mean   : 70.12      </span></span>
<span><span class="co">#&gt;  3rd Qu.:163.48               3rd Qu.:0.013392          3rd Qu.: 82.73      </span></span>
<span><span class="co">#&gt;  Max.   :234.05               Max.   :0.032101          Max.   :107.68      </span></span>
<span><span class="co">#&gt;                                                         NA's   :95613       </span></span>
<span><span class="co">#&gt;  with_cancer     param_cancer_death_intercept param_cancer_death_slope</span></span>
<span><span class="co">#&gt;  Mode :logical   Min.   :-3.817               Min.   :3.500e-09       </span></span>
<span><span class="co">#&gt;  FALSE:95613     1st Qu.:-3.134               1st Qu.:7.468e-04       </span></span>
<span><span class="co">#&gt;  TRUE :4387      Median :-3.000               Median :1.507e-03       </span></span>
<span><span class="co">#&gt;                  Mean   :-3.000               Mean   :1.502e-03       </span></span>
<span><span class="co">#&gt;                  3rd Qu.:-2.866               3rd Qu.:2.257e-03       </span></span>
<span><span class="co">#&gt;                  Max.   :-2.140               Max.   :3.000e-03       </span></span>
<span><span class="co">#&gt;                                                                       </span></span>
<span><span class="co">#&gt;  age_dead_from_cancer_causes    age_dead      param_clinical_cancer_dx_rate</span></span>
<span><span class="co">#&gt;  Min.   : 40.20              Min.   : 40.01   Min.   :0.20                 </span></span>
<span><span class="co">#&gt;  1st Qu.: 61.91              1st Qu.: 72.35   1st Qu.:0.22                 </span></span>
<span><span class="co">#&gt;  Median : 73.63              Median : 82.26   Median :0.24                 </span></span>
<span><span class="co">#&gt;  Mean   : 72.40              Mean   : 79.87   Mean   :0.24                 </span></span>
<span><span class="co">#&gt;  3rd Qu.: 83.16              3rd Qu.: 89.36   3rd Qu.:0.25                 </span></span>
<span><span class="co">#&gt;  Max.   :108.17              Max.   :109.87   Max.   :0.27                 </span></span>
<span><span class="co">#&gt;  NA's   :97768                                NA's   :95613                </span></span>
<span><span class="co">#&gt;  age_clinical_cancer_dx</span></span>
<span><span class="co">#&gt;  Min.   : 40.31        </span></span>
<span><span class="co">#&gt;  1st Qu.: 58.56        </span></span>
<span><span class="co">#&gt;  Median : 72.68        </span></span>
<span><span class="co">#&gt;  Mean   : 70.95        </span></span>
<span><span class="co">#&gt;  3rd Qu.: 82.96        </span></span>
<span><span class="co">#&gt;  Max.   :106.46        </span></span>
<span><span class="co">#&gt;  NA's   :96980</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="bibliography">Bibliography<a class="anchor" aria-label="anchor" href="#bibliography"></a>
</h2>
<p>Trikalinos TA, Sereda Y. <em>nhppp: Simulating Nonhomogeneous Poisson
Point Processes in R</em>. arXiv preprint arXiv:2402.00358. 2024 Feb
1.</p>
<p>Since the publication of the paper, the syntax and options of the
<code>nhppp</code> package have evolved. To reproduce the code in the
paper, you have to install the version of <code>nhppp</code> used in the
paper. Alternatively, take a look at the vignettes, which are written to
work with the current package.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thomas Trikalinos, Yuliia Sereda.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
